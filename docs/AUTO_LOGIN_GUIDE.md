# 自动登录获取 Cookie 功能使用指南

## 🎉 功能概述

网页存档 Widget 现在支持**自动登录获取 Cookie**功能！无需手动复制 Cookie，只需点击按钮，在弹出的登录窗口中完成登录即可。

## ✨ 特性

- 🪟 **独立登录窗口** - 打开独立的浏览器窗口进行登录
- 🔐 **安全隔离** - 使用独立 Session，不影响主窗口
- 🎯 **自动捕获** - 登录完成后自动提取所有 Cookie
- 💾 **即时填充** - Cookie 自动填充到表单，无需手动粘贴
- 🔄 **支持 2FA** - 完整支持双因素认证流程
- 📊 **详细反馈** - 显示捕获的 Cookie 数量和域名信息

## 🚀 使用步骤

### 1. 添加新网页

1. 点击"添加网页"按钮
2. 输入目标网页 URL（如 `https://example.com`）
3. 展开"身份验证配置"区域
4. 选择验证方式：**Cookie（自动登录获取）**

### 2. 自动登录

1. 点击 **"自动登录获取 Cookie"** 按钮
2. 等待登录窗口弹出
3. 在登录窗口中正常登录（支持所有登录方式：密码、2FA、验证码等）
4. 登录成功后，点击窗口右上角的 **"✓ 登录完成"** 按钮

### 3. 完成配置

- Cookie 会自动填充到表单中
- 点击"添加"保存配置
- 系统会立即使用该 Cookie 进行抓取测试

## 🎯 使用场景

### 场景 1：需要登录的新闻网站
```
URL: https://news-site.com
验证方式: Cookie（自动登录获取）
操作: 点击自动登录 → 在弹窗中登录 → 确认
```

### 场景 2：会员专区内容
```
URL: https://member.site.com/premium-content
验证方式: Cookie（自动登录获取）
操作: 自动登录 → 输入账号密码 → 完成 2FA → 确认
```

### 场景 3：社交媒体私人内容
```
URL: https://social-media.com/feed
验证方式: Cookie（自动登录获取）
操作: 自动登录 → 授权登录 → 确认
```

## ⚙️ 工作原理

1. **打开窗口**: 创建独立的 Electron BrowserWindow
2. **加载页面**: 窗口加载目标网站的登录页面
3. **用户登录**: 用户在窗口中完成登录流程
4. **捕获 Cookie**: 从窗口 Session 中提取所有 Cookie
5. **格式化**: 将 Cookie 格式化为标准字符串格式
6. **自动填充**: Cookie 填充到表单的 Cookie 字段
7. **关闭窗口**: 自动关闭登录窗口

## 🔍 技术细节

### Cookie 提取范围
- 目标域名的所有 Cookie
- 父域名的 Cookie（如 `.example.com`）
- 自动过滤已过期的 Cookie
- 自动去重

### 安全特性
- **独立 Session Partition** - 每次登录使用独立的 Session
- **不污染主窗口** - 登录数据不会影响主应用
- **本地处理** - 所有 Cookie 处理在本地完成
- **临时存储** - 登录 Session 在窗口关闭后销毁

## 💡 高级技巧

### 手动确认 vs 自动检测

目前默认使用**手动确认**模式，更加可靠：
- ✅ 用户完全控制确认时机
- ✅ 适用于所有网站
- ✅ 避免误判

未来可能添加**自动检测**选项：
- 检测 URL 跳转（如跳转到 /home 或 /dashboard）
- 检测 Cookie 数量变化
- 检测 LocalStorage 中的认证标记

### 处理特殊情况

**Cookie 无效怎么办？**
- 确保在登录完成后再点击确认按钮
- 某些网站需要完全加载完成后 Cookie 才会设置
- 可以等待几秒后再确认

**窗口没有弹出？**
- 检查是否被系统拦截弹窗
- 查看控制台是否有错误信息
- 尝试重新点击按钮

**登录成功但 Cookie 为空？**
- 某些网站使用非标准的认证方式（如 LocalStorage）
- 这种情况仍需手动复制 Cookie
- 或者使用 Bearer Token 方式

## 📝 对比手动复制

| 特性 | 自动登录 | 手动复制 |
|------|---------|---------|
| 操作步骤 | 1 步（点击按钮） | 4-5 步 |
| 出错概率 | 低 | 中等 |
| 支持 2FA | ✅ 原生支持 | ✅ 支持 |
| 学习成本 | 低 | 需要了解开发者工具 |
| 适用范围 | 几乎所有网站 | 所有网站 |

## 🐛 故障排查

### 问题 1：登录窗口一闪而过
**原因**: 可能触发了自动检测（未来功能）
**解决**: 重新打开，快速完成登录

### 问题 2：Cookie 数量显示为 0
**原因**: 网站未设置 Cookie，可能使用其他认证方式
**解决**: 尝试使用 Bearer Token 或自定义 Headers

### 问题 3：抓取仍然显示未登录
**原因**: Cookie 可能不完整或已过期
**解决**: 重新登录获取新的 Cookie

## 🔗 相关文档

- [网页存档身份验证指南](./WEB_ARCHIVE_AUTH_GUIDE.md)
- [Widget 开发规范](../AGENTS.md)

## 💬 反馈与建议

如有问题或建议，请在项目仓库提交 Issue。
